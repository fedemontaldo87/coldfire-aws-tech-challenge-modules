name: ‚úÖ Validate Terraform Modules

on:
  pull_request:
    paths:
      - 'terraform-aws-*/**'
      - '**/test/**'
  push:
    branches: [ main ]

jobs:
  test-modules:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - module: alb
            path: terraform-aws-alb
          - module: asg
            path: terraform-aws-asg
          - module: cloudwatch
            path: terraform-aws-cloudwatch-monitoring
          - module: ec2
            path: terraform-aws-ec2-instance
          - module: iam_role
            path: terraform-aws-iam-roles
          - module: s3
            path: terraform-aws-s3
          - module: security_group
            path: terraform-aws-security-groups
          - module: vpc
            path: terraform-aws-vpc

    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üß∞ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: üõ†Ô∏è Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.4

      - name: üîê Configure dummy AWS credentials
        run: |
          SCRIPT_PATH=${{ matrix.path }}/test/${{ matrix.module }}/create_dummy_profile.sh
          if [ -f "$SCRIPT_PATH" ]; then
            chmod +x "$SCRIPT_PATH"
            "$SCRIPT_PATH"
          else
            echo "‚ö†Ô∏è No create_dummy_profile.sh script found for ${{ matrix.module }}"
          fi

      - name: ‚úÖ Run Go Terratest for ${{ matrix.module }}
        working-directory: ${{ matrix.path }}/test/${{ matrix.module }}
        run: go test -v
