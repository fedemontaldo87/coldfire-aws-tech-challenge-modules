name: âœ… Validate Terraform Modules

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - 'terraform-aws-*/**'
      - 'test/**'

jobs:
  test-modules:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        module:
          - iam_role
          - vpc
          - ec2-instance
          - alb
          - s3
          - asg
          - security_group
          - cloudwatch

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: â›ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.4

      - name: ğŸ” Create dummy AWS profile
        run: |
          chmod +x terraform-aws-${{ matrix.module }}/test/${{ matrix.module }}/create_dummy_profile.sh
          terraform-aws-${{ matrix.module }}/test/${{ matrix.module }}/create_dummy_profile.sh

      - name: âœ… Run Go Terratest
        working-directory: test/${{ matrix.module }}
        run: go test -v

  tfsec-check:
    name: ğŸ”’ tfsec Static Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: ğŸš¨ Run tfsec
        run: |
          for dir in terraform-aws-*; do
            echo "ğŸ” Scanning $dir..."
            tfsec "$dir"
          done
